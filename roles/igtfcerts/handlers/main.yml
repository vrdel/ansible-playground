---

# add handlers

- name: Backup CA bundle
  listen: Update CA bundle
  include_tasks: ./backup_bundle.yml
  loop: "{{ target_cabundles }}"

- name: Clean anchors/
  listen: Update CA bundle
  include_tasks: ./clean_anchors.yml

- name: "List all target IGTF target *.pem files"
  listen: Update CA bundle
  ansible.builtin.find:
    paths: /etc/grid-security/certificates/
    patterns: '*.pem'
  register: target_pems

- name: Copy IGTF CA's as anchors
  listen: Update CA bundle
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ anchor_path }}"
    remote_src: yes
  loop: "{{ target_pems.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: Update bundle
  listen: Update CA bundle
  ansible.builtin.command:
    cmd: update-ca-trust


# clean handlers

- name: Clean anchors/
  listen: Reset CA bundle
  include_tasks: ./clean_anchors.yml

- name: Revert back original CA bundle - tls-ca-bundle.pem
  listen: Reset CA bundle
  ansible.builtin.copy:
    src: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem.saved.igtfcerts-role
    dest: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
    remote_src: yes
    force: true
  ignore_errors: true

- name: Delete /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem.saved.igtfcerts-role
  listen: Reset CA bundle
  ansible.builtin.file:
    path: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem.saved.igtfcerts-role
    state: absent
  ignore_errors: true

- name: Revert back original CA bundle - ca-bundle.trust.crt
  listen: Reset CA bundle
  ansible.builtin.copy:
    src: /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt.saved.igtfcerts-role
    dest: /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt
    remote_src: yes
    force: true
  ignore_errors: true

- name: Delete /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt.saved.igtfcerts-role
  listen: Reset CA bundle
  ansible.builtin.file:
    src: /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt.saved.igtfcerts-role
    state: absent
  ignore_errors: true
